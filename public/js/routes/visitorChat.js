// Generated by CoffeeScript 1.3.3
(function() {

  define(["app/server", "app/notify", "templates/newChat", "templates/chatMessage"], function(server, notify, newChat, chatMessage) {
    return function(_arg, templ) {
      var id;
      id = _arg.id;
      $("#content").html(templ());
      $("#message-form #message").focus();
      return server.refresh(function(services) {
        var appendChat;
        $(".message-form").submit(function() {
          var message;
          if ($(".message").val() !== "") {
            message = $(".message").val();
            server[id](message, function(err, data) {
              if (err && (typeof console !== "undefined" && console !== null)) {
                return console.log(err);
              }
            });
            $(".message").val("");
            $(".chat-display-box").scrollTop($(".chat-display-box").prop("scrollHeight"));
          }
          return false;
        });
        appendChat = function(err, data) {
          if (err) {
            console.log("Error appending chat: " + err);
          }
          return $(".chat-display-box").append(chatMessage(data));
        };
        return server.getChatHistory(server.cookie('channel'), function(err, history) {
          var msg, _i, _len;
          if (err) {
            notify.error("Error loading chat history: " + err);
          }
          for (_i = 0, _len = history.length; _i < _len; _i++) {
            msg = history[_i];
            appendChat(null, msg);
          }
          return server.subscribe[id](appendChat);
        });
      });
    };
  });

}).call(this);
