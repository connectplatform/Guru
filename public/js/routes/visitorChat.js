// Generated by CoffeeScript 1.3.1
(function() {

  define(["app/server", "app/pulsar", "app/notify", "templates/newChat", "templates/chatMessage"], function(server, pulsar, notify, newChat, chatMessage) {
    return function(_arg, templ) {
      var channel, id;
      id = _arg.id;
      $("#content").html(templ());
      $("#message-form #message").focus();
      channel = pulsar.channel(id);
      return server.refresh(function(services) {
        var appendChat;
        $(".message-form").submit(function(evt) {
          var message;
          evt.preventDefault();
          if ($(".message").val() !== "") {
            message = $(".message").val();
            channel.emit('clientMessage', {
              message: message,
              session: server.cookie('session')
            });
            $(".message").val("");
            $(".chat-display-box").scrollTop($(".chat-display-box").prop("scrollHeight"));
          }
          return false;
        });
        appendChat = function(data) {
          console.log(data);
          return $(".chat-display-box").append(chatMessage(data));
        };
        return server.getChatHistory(server.cookie('channel'), function(err, history) {
          var msg, _i, _len;
          if (err) {
            notify.error("Error loading chat history: " + err);
          }
          for (_i = 0, _len = history.length; _i < _len; _i++) {
            msg = history[_i];
            appendChat(null, msg);
          }
          return channel.on('serverMessage', appendChat);
        });
      });
    };
  });

}).call(this);
