// Generated by CoffeeScript 1.3.3
(function() {

  define(["load/server", "load/notify"], function(server, notify) {
    return function(_, templ, queryString) {
      if (queryString == null) {
        queryString = {};
      }
      $("#content").html("Loading...");
      return server.ready(function() {
        delete queryString["undefined"];
        return server.getExistingChatChannel(function(err, data) {
          if ((data != null) && !!data) {
            window.location.hash = "/visitorChat/" + data.channel;
          }
          $("#content").html(templ());
          $("#newChat-form #username").focus();
          return $("#newChat-form").submit(function(evt) {
            var referrer, referrerArray, username;
            evt.preventDefault();
            username = $("#newChat-form #username").val();
            if (!queryString.websiteUrl) {
              referrer = document.referrer || "";
              referrerArray = referrer.split("/");
              if (referrerArray.length >= 2) {
                queryString.websiteUrl = referrerArray[0] + referrerArray[1] + referrerArray[2];
              }
            }
            server.newChat({
              username: username,
              referrerData: queryString
            }, function(err, chat) {
              if (err != null) {
                $("#content").html(templ());
                return notify.error("Error connecting to chat: " + err);
              } else {
                return window.location.hash = "/visitorChat/" + chat.chatId;
              }
            });
            return $("#content").html("Connecting to chat...");
          });
        });
      });
    };
  });

}).call(this);
