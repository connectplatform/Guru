// Generated by CoffeeScript 1.3.3
(function() {

  define(["guru/server", "templates/newChat", "templates/chatBox"], function(server, newChat, chatBox) {
    return function(_arg, templ) {
      var id;
      id = _arg.id;
      $("#content").html(templ());
      $("#message-form #message").focus();
      return server.refresh(function(services) {
        console.log("username: " + (server.cookie('username')));
        console.log("services: " + services);
        $("#message-form").submit(function() {
          var message;
          if ($("#message").val() !== "") {
            message = $("#message").val();
            console.log("sent: " + message);
            server[id](message, function(err, data) {
              if (err && (typeof console !== "undefined" && console !== null)) {
                return console.log(err);
              }
            });
            $("#message").val("");
            $("#chat-display-box").scrollTop($("#chat-display-box").prop("scrollHeight"));
          }
          return false;
        });
        return server.getChatHistory(server.cookie('channel'), function(err, data) {
          if (data && !err) {
            $("#chat-display-box").html(chatBox({
              history: data
            }));
          }
          return server.subscribe[id](function(err, data) {
            return $("#chat-display-box").append("<p>" + (unescape(data.username)) + ": " + data.message + "</p>");
          });
        });
      });
    };
  });

}).call(this);
